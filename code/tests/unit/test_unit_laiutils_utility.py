import imp
import os

modulename = 'laiutils'
modulepath = os.path.join(os.path.dirname(os.path.abspath(__file__)), "../../")
file, pathname, description = imp.find_module(modulename, [modulepath])
laiutils = imp.load_module(modulename, file, pathname, description)

test_raw = [
    {'updated': '1425766039', 'area': '58', 'lon': '-89.160927', 'created': '1414630393', 'mcc': '310', 'cell': '6097', 'averageSignal': '', 'range': '4105', 'radio': 'CDMA', 'samples': '13', 'lat': '40.311561', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1414630527', 'area': '58', 'lon': '-89.169277', 'created': '1414630527', 'mcc': '310', 'cell': '1666', 'averageSignal': '', 'range': '0', 'radio': 'CDMA', 'samples': '1', 'lat': '40.311406', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425765974', 'area': '58', 'lon': '-89.161825', 'created': '1414659867', 'mcc': '310', 'cell': '6082', 'averageSignal': '', 'range': '2539', 'radio': 'CDMA', 'samples': '6', 'lat': '40.311987', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425760008', 'area': '58', 'lon': '-89.120056', 'created': '1425760008', 'mcc': '310', 'cell': '2321', 'averageSignal': '', 'range': '0', 'radio': 'CDMA', 'samples': '1', 'lat': '40.588591', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425764149', 'area': '58', 'lon': '-89.119942', 'created': '1425762248', 'mcc': '310', 'cell': '6081', 'averageSignal': '', 'range': '18', 'radio': 'CDMA', 'samples': '4', 'lat': '40.588557', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425762383', 'area': '58', 'lon': '-89.120133', 'created': '1425762383', 'mcc': '310', 'cell': '6099', 'averageSignal': '', 'range': '0', 'radio': 'CDMA', 'samples': '1', 'lat': '40.588592', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425765917', 'area': '58', 'lon': '-89.156099', 'created': '1425765914', 'mcc': '310', 'cell': '2322', 'averageSignal': '', 'range': '324', 'radio': 'CDMA', 'samples': '2', 'lat': '40.311767', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425772601', 'area': '58', 'lon': '-89.81093', 'created': '1425772419', 'mcc': '310', 'cell': '6147', 'averageSignal': '', 'range': '3033', 'radio': 'CDMA', 'samples': '5', 'lat': '40.301849', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425772726', 'area': '58', 'lon': '-89.855481', 'created': '1425772556', 'mcc': '310', 'cell': '6193', 'averageSignal': '', 'range': '2430', 'radio': 'CDMA', 'samples': '6', 'lat': '40.298498', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425772679', 'area': '58', 'lon': '-89.865195', 'created': '1425772679', 'mcc': '310', 'cell': '6163', 'averageSignal': '', 'range': '0', 'radio': 'CDMA', 'samples': '1', 'lat': '40.296426', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425772979', 'area': '58', 'lon': '-89.923868', 'created': '1425772766', 'mcc': '310', 'cell': '6194', 'averageSignal': '', 'range': '3120', 'radio': 'CDMA', 'samples': '5', 'lat': '40.297121', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1425773931', 'area': '58', 'lon': '-90.175023', 'created': '1425773826', 'mcc': '310', 'cell': '2338', 'averageSignal': '', 'range': '1217', 'radio': 'CDMA', 'samples': '4', 'lat': '40.305361', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1404765098', 'area': '58', 'lon': '-90.055299', 'created': '1404764717', 'mcc': '310', 'cell': '5054', 'averageSignal': '', 'range': '35', 'radio': 'CDMA', 'samples': '6', 'lat': '40.293858', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1404761085', 'area': '58', 'lon': '-89.755461', 'created': '1404761036', 'mcc': '310', 'cell': '4842', 'averageSignal': '', 'range': '1260', 'radio': 'CDMA', 'samples': '4', 'lat': '40.304286', 'net': '4112', 'changeable': '1', 'unit': ''},
    {'updated': '1405037065', 'area': '58', 'lon': '-88.544739', 'created': '1405037065', 'mcc': '310', 'cell': '8710', 'averageSignal': '', 'range': '0', 'radio': 'CDMA', 'samples': '1', 'lat': '42.088344', 'net': '4112', 'changeable': '1', 'unit': ''}
    ]
test_prelim = [
    ('310-4112-58-8710', '310-4112-58-6097', 68622.82728130736),
    ('310-4112-58-8710', '310-4112-58-1666', 69548.87153244636),
    ('310-4112-58-8710', '310-4112-58-6082', 68722.3629349988),
    ('310-4112-58-8710', '310-4112-58-2321', 64057.048342389564),
    ('310-4112-58-8710', '310-4112-58-6081', 64044.40369713602),
    ('310-4112-58-8710', '310-4112-58-6099', 64065.591510622595),
    ('310-4112-58-8710', '310-4112-58-2322', 68087.4011971862),
    ('310-4112-58-8710', '310-4112-58-6147', 140805.75925871724),
    ('310-4112-58-8710', '310-4112-58-6193', 145756.5648050029),
    ('310-4112-58-8710', '310-4112-58-6163', 146836.08622642644),
    ('310-4112-58-8710', '310-4112-58-6194', 153356.5128032503),
    ('310-4112-58-8710', '310-4112-58-2338', 181270.8984897945),
    ('310-4112-58-8710', '310-4112-58-5054', 167963.7031532931),
    ('310-4112-58-8710', '310-4112-58-4842', 134641.98546262176),
    ('310-4112-58-4842', '310-4112-58-6097', 66109.1648270363),
    ('310-4112-58-4842', '310-4112-58-1666', 65180.68717774446),
    ('310-4112-58-4842', '310-4112-58-6082', 66009.31182035228),
    ('310-4112-58-4842', '310-4112-58-2321', 70654.27593897968),
    ('310-4112-58-4842', '310-4112-58-6081', 70666.95202664395),
    ('310-4112-58-4842', '310-4112-58-6099', 70645.7139485051),
    ('310-4112-58-4842', '310-4112-58-2322', 66646.01394987572),
    ('310-4112-58-4842', '310-4112-58-6147', 6167.871469885387),
    ('310-4112-58-4842', '310-4112-58-6193', 11121.716763460732),
    ('310-4112-58-4842', '310-4112-58-6163', 12201.864394730965),
    ('310-4112-58-4842', '310-4112-58-6194', 18726.004107547902),
    ('310-4112-58-4842', '310-4112-58-2338', 46653.16581084898),
    ('310-4112-58-4842', '310-4112-58-5054', 33340.464332193034),
    ('310-4112-58-5054', '310-4112-58-6097', 99449.62865758571),
    ('310-4112-58-5054', '310-4112-58-1666', 98521.15102507373),
    ('310-4112-58-5054', '310-4112-58-6082', 99349.77560006737),
    ('310-4112-58-5054', '310-4112-58-2321', 103994.20023490606),
    ('310-4112-58-5054', '310-4112-58-6081', 104006.87647361857),
    ('310-4112-58-5054', '310-4112-58-6099', 103985.63822543263),
    ('310-4112-58-5054', '310-4112-58-2322', 99986.47775688092),
    ('310-4112-58-5054', '310-4112-58-6147', 27172.59298293443),
    ('310-4112-58-5054', '310-4112-58-6193', 22218.747837679857),
    ('310-4112-58-5054', '310-4112-58-6163', 21138.60033045817),
    ('310-4112-58-5054', '310-4112-58-6194', 14614.460398045107),
    ('310-4112-58-5054', '310-4112-58-2338', 13312.701578752796),
    ('310-4112-58-2338', '310-4112-58-6097', 112762.33023626145),
    ('310-4112-58-2338', '310-4112-58-1666', 111833.85260359087),
    ('310-4112-58-2338', '310-4112-58-6082', 112662.47717875495),
    ('310-4112-58-2338', '310-4112-58-2321', 117306.77983950045),
    ('310-4112-58-2338', '310-4112-58-6081', 117319.45610449367),
    ('310-4112-58-2338', '310-4112-58-6099', 117298.21783162966),
    ('310-4112-58-2338', '310-4112-58-2322', 113299.17933563355),
    ('310-4112-58-2338', '310-4112-58-6147', 40485.29440781213),
    ('310-4112-58-2338', '310-4112-58-6193', 35531.449186711885),
    ('310-4112-58-2338', '310-4112-58-6163', 34451.30162946758),
    ('310-4112-58-2338', '310-4112-58-6194', 27927.161740406),
    ('310-4112-58-6194', '310-4112-58-6097', 84835.16882480361),
    ('310-4112-58-6194', '310-4112-58-1666', 83906.69118129973),
    ('310-4112-58-6194', '310-4112-58-6082', 84735.31579841468),
    ('310-4112-58-6194', '310-4112-58-2321', 89379.93628757219),
    ('310-4112-58-6194', '310-4112-58-6081', 89392.6124797671),
    ('310-4112-58-6194', '310-4112-58-6099', 89371.37428003886),
    ('310-4112-58-6194', '310-4112-58-2322', 85372.01793896708),
    ('310-4112-58-6194', '310-4112-58-6147', 12558.132673635824),
    ('310-4112-58-6194', '310-4112-58-6193', 7604.287453608417),
    ('310-4112-58-6194', '310-4112-58-6163', 6524.139932447509),
    ('310-4112-58-6163', '310-4112-58-6097', 78311.02922118091),
    ('310-4112-58-6163', '310-4112-58-1666', 77382.55157218015),
    ('310-4112-58-6163', '310-4112-58-6082', 78211.17621275884),
    ('310-4112-58-6163', '310-4112-58-2321', 82855.90658020102),
    ('310-4112-58-6163', '310-4112-58-6081', 82868.58274288886),
    ('310-4112-58-6163', '310-4112-58-6099', 82847.34457607011),
    ('310-4112-58-6163', '310-4112-58-2322', 78847.87834339774),
    ('310-4112-58-6163', '310-4112-58-6147', 6033.992928303155),
    ('310-4112-58-6163', '310-4112-58-6193', 1080.147663246704),
    ('310-4112-58-6193', '310-4112-58-6097', 77230.88158524026),
    ('310-4112-58-6193', '310-4112-58-1666', 76302.40393688934),
    ('310-4112-58-6193', '310-4112-58-6082', 77131.0285746796),
    ('310-4112-58-6193', '310-4112-58-2321', 81775.77537178078),
    ('310-4112-58-6193', '310-4112-58-6081', 81788.45152938344),
    ('310-4112-58-6193', '310-4112-58-6099', 81767.21336836826),
    ('310-4112-58-6193', '310-4112-58-2322', 77767.73070650079),
    ('310-4112-58-6193', '310-4112-58-6147', 4953.845293582055),
    ('310-4112-58-6147', '310-4112-58-6097', 72277.03629361927),
    ('310-4112-58-6147', '310-4112-58-1666', 71348.55864490024),
    ('310-4112-58-6147', '310-4112-58-6082', 72177.18328457882),
    ('310-4112-58-6147', '310-4112-58-2321', 76822.01907255709),
    ('310-4112-58-6147', '310-4112-58-6081', 76834.69520279653),
    ('310-4112-58-6147', '310-4112-58-6099', 76813.45707357727),
    ('310-4112-58-6147', '310-4112-58-2322', 72813.88541549905),
    ('310-4112-58-2322', '310-4112-58-6097', 536.8492112397558),
    ('310-4112-58-2322', '310-4112-58-1666', 1465.326860727815),
    ('310-4112-58-2322', '310-4112-58-6082', 636.7022512170527),
    ('310-4112-58-2322', '310-4112-58-2321', 4034.446934270436),
    ('310-4112-58-2322', '310-4112-58-6081', 4047.03661428605),
    ('310-4112-58-2322', '310-4112-58-6099', 4025.9394616737927),
    ('310-4112-58-6099', '310-4112-58-6097', 4559.546048762214),
    ('310-4112-58-6099', '310-4112-58-1666', 5483.881157423922),
    ('310-4112-58-6099', '310-4112-58-6082', 4658.801493210732),
    ('310-4112-58-6099', '310-4112-58-2321', 8.562009520396439),
    ('310-4112-58-6099', '310-4112-58-6081', 21.238315091511836),
    ('310-4112-58-6081', '310-4112-58-6097', 4580.674677647681),
    ('310-4112-58-6081', '310-4112-58-1666', 5505.044179902131),
    ('310-4112-58-6081', '310-4112-58-6082', 4679.935153144043),
    ('310-4112-58-6081', '310-4112-58-2321', 12.676354621422817),
    ('310-4112-58-2321', '310-4112-58-6097', 4568.065961596674),
    ('310-4112-58-2321', '310-4112-58-1666', 5492.414598814301),
    ('310-4112-58-2321', '310-4112-58-6082', 4667.323389691917),
    ('310-4112-58-6082', '310-4112-58-6097', 99.85545098523275),
    ('310-4112-58-6082', '310-4112-58-1666', 828.6251274880854),
    ('310-4112-58-1666', '310-4112-58-6097', 928.4776714443033)
    ]

test_final = {'310-4112-58-2338': {'distance': 13312.701578752796,
                                   'nearest': '310-4112-58-5054'},
              '310-4112-58-6194': {'distance': 6524.139932447509,
                                   'nearest': '310-4112-58-6163'},
              '310-4112-58-6163': {'distance': 1080.147663246704,
                                   'nearest': '310-4112-58-6193'},
              '310-4112-58-8710': {'distance': 64044.40369713602,
                                   'nearest': '310-4112-58-6081'},
              '310-4112-58-2321': {'distance': 8.562009520396439,
                                   'nearest': '310-4112-58-6099'},
              '310-4112-58-6147': {'distance': 4953.845293582055,
                                   'nearest': '310-4112-58-6193'},
              '310-4112-58-2322': {'distance': 536.8492112397558,
                                   'nearest': '310-4112-58-6097'},
              '310-4112-58-4842': {'distance': 6167.871469885387,
                                   'nearest': '310-4112-58-6147'},
              '310-4112-58-6099': {'distance': 8.562009520396439,
                                   'nearest': '310-4112-58-2321'},
              '310-4112-58-6081': {'distance': 12.676354621422817,
                                   'nearest': '310-4112-58-2321'},
              '310-4112-58-6082': {'distance': 99.85545098523275,
                                   'nearest': '310-4112-58-6097'},
              '310-4112-58-1666': {'distance': 828.6251274880854,
                                   'nearest': '310-4112-58-6082'},
              '310-4112-58-6193': {'distance': 1080.147663246704,
                                   'nearest': '310-4112-58-6163'},
              '310-4112-58-5054': {'distance': 13312.701578752796,
                                   'nearest': '310-4112-58-2338'}}


class TestUtility:
    def test_utility_mcc_mnc_lac_from_filename(self):
        sample = "/etc/whatever/nothing/310-411-266-42302.csv.gz"
        expected = ("310", "411", "266")
        assert expected == laiutils.Utility.mcc_mnc_lac_from_filename(sample)

    def test_utility_cgi_from_ocid_row(self):
        sample = {"mcc": "310", "net": "411", "area": "266", "cell": "42302"}
        expected = "310-411-266-42302"
        assert expected == laiutils.Utility.cgi_from_ocid_row(sample)

    def test_utility_create_preliminary_neighbors_struct(self):
        in_s = test_raw
        out_s = laiutils.Utility.create_preliminary_neighbors_struct(in_s)
        assert out_s == test_prelim

    def test_utility_transform_prelim_into_final(self):
        in_s = test_prelim
        out_s = laiutils.Utility.transform_prelim_into_final(in_s)
        assert out_s == test_final
